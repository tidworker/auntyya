<script>
  // 新增全域變數，用來儲存已記錄的訂單群組
  let orderGroups = [];

  /* ------------------ 語音辨識處理 ------------------ */
  function startVoiceInputSingle() {
    return new Promise((resolve) => {
      if (!("webkitSpeechRecognition" in window) && !("SpeechRecognition" in window)) {
        alert("您的瀏覽器不支援語音輸入功能。");
        resolve(null);
        return;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      currentRecognition = recognition;
      recognition.lang = "zh-TW";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = function(event) {
        currentRecognition = null;
        resolve(event.results[0][0].transcript);
      };
      recognition.onerror = function(event) {
        currentRecognition = null;
        if (holdActive) {
          resolve("_RESTART_");
        } else {
          resolve(null);
        }
      };
      recognition.start();
    });
  }

  function continuousRecognition() {
    if (!holdActive) return;
    startVoiceInputSingle().then((transcript) => {
      if (!holdActive) return;
      if (transcript === "_RESTART_") {
        continuousRecognition();
        return;
      }
      if (transcript && transcript.trim() !== "") {
        let text = transcript.trim();
        switch (currentMode) {
          case "red":
            // 紅色模式：直接加入訂單
            let orders = processMultipleVoiceInput(text);
            if (orders.length > 0) {
              orders.forEach((order) => {
                addOrderRow(order.dish, order.quantity, "");
              });
              updateTotalAmount();
            }
            break;
          case "green":
            // 綠色模式：將內容加入 #voiceOutput，以逗號分隔
            let voiceOutputDiv = document.getElementById("voiceOutput");
            let currentText = voiceOutputDiv.innerText.trim();
            if (currentText === "") {
              voiceOutputDiv.innerText = text;
            } else {
              voiceOutputDiv.innerText = currentText + "," + text;
            }
            break;
          default:
            break;
        }
      }
      if (holdActive) continuousRecognition();
    });
  }

  /* ------------------ 滑動方向動作（錄音按鈕） ------------------ */
  // 修改 updateButtonPosition：將垂直拖曳的功能交換
  function updateButtonPosition(currentX, currentY) {
    let deltaX = currentX - startX;
    let deltaY = currentY - startY;
    if (!swipeToggled && (Math.abs(deltaX) > 30 || Math.abs(deltaY) > 30)) {
      if (Math.abs(deltaX) > Math.abs(deltaY)) {
        // 水平拖曳：立即執行
        if (deltaX < 0) {
          deleteCurrentVoiceLine();
        } else {
          startGreenMode();
        }
        swipeToggled = true;
      } else {
        // 垂直拖曳：根據方向執行不同功能
        if (deltaY < 0) {
          // 往上拖曳：立即啟動語音訂餐（原本往下的功能）
          startOrdering();
          swipeToggled = true;
        } else {
          // 往下拖曳：記錄為「記錄訂單」手勢，稍後在放開時執行
          gestureDirection = "down";
          swipeToggled = true;
        }
      }
    }
    if (deltaX !== 0 || deltaY !== 0) {
      const angle = Math.atan2(deltaY, deltaX);
      voiceButton.style.transform = `translate(-50%, 0) translate(${20 * Math.cos(angle)}px, ${20 * Math.sin(angle)}px)`;
    }
  }

  // 修改 endDrag：針對 downward 手勢呼叫 recordOrderGroup()，移除原本針對 up 手勢的判斷
  function endDrag() {
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
    holdActive = false;
    if (currentRecognition) {
      currentRecognition.stop();
    }
    voiceButton.style.transform = "translate(-50%, 0)";
    voiceButton.style.backgroundColor = "red";
    if (gestureDirection === "down") {
      // 往下放開：記錄目前訂單，並新增一組新的訂單
      recordOrderGroup();
    }
    // 重置手勢方向
    gestureDirection = "";
    currentMode = "red";
  }

  // 新增函式：記錄目前訂單群組，並清空訂單表格供下一組訂單使用
  function recordOrderGroup() {
    const tbody = document.getElementById("orderTable").getElementsByTagName("tbody")[0];
    if (tbody.rows.length === 0) {
      // 若目前無訂單，不做任何動作
      vibrateOnce();
      return;
    }
    let orderGroup = [];
    for (let i = 0; i < tbody.rows.length; i++) {
      let row = tbody.rows[i];
      orderGroup.push({
        dish: row.cells[0].innerText,
        quantity: row.cells[1].innerText,
        remark: row.cells[2].innerText,
        price: row.cells[3].innerText
      });
    }
    orderGroups.push(orderGroup);
    // 清空訂單，新增一組新的訂單
    resetOrder();
    vibrateOnce();
    // 可根據需求加入提示訊息，例如：alert("訂單已記錄，請開始新的訂單");
  }

  /* ------------------ 錄音按鈕事件監聽 ------------------ */
  const voiceButton = document.getElementById("voiceButton");
  voiceButton.addEventListener("mousedown", function(e) {
    startX = e.pageX;
    startY = e.pageY;
    swipeToggled = false;
    holdActive = true;
    gestureStartTime = Date.now();
    gestureDirection = "";
    e.preventDefault();
  });
  voiceButton.addEventListener("touchstart", function(e) {
    startX = e.touches[0].pageX;
    startY = e.touches[0].pageY;
    swipeToggled = false;
    holdActive = true;
    gestureStartTime = Date.now();
    gestureDirection = "";
    e.preventDefault();
  });
  voiceButton.addEventListener("mousemove", function(e) {
    if (holdActive) {
      updateButtonPosition(e.pageX, e.pageY);
    }
  });
  voiceButton.addEventListener("touchmove", function(e) {
    if (holdActive) {
      updateButtonPosition(e.touches[0].pageX, e.touches[0].pageY);
    }
    e.preventDefault();
  });
  voiceButton.addEventListener("mouseup", function(e) {
    endDrag();
    e.preventDefault();
  });
  voiceButton.addEventListener("touchend", function(e) {
    endDrag();
    e.preventDefault();
  });

  // 其他原有程式碼保持不變…
</script>