<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>語音點餐系統</title>
  <style>
    /* ========= 全域樣式 ========= */
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #4a4a4a;
      color: white;
      padding: 10px 0;
      text-align: center;
    }
    main {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      position: relative;
    }
    h1, h2 {
      margin: 0 0 20px;
      font-weight: normal;
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-size: 18px;
    }
    #inputTextArea {
      width: 100%;
      height: 80px;
      margin-bottom: 20px;
      border-radius: 5px;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 14px;
      resize: none;
      background-color: #f9f9f9;
    }

    /* ========= 按鈕樣式 ========= */
    #voiceBtn,
    #clearInputBtn,
    #incrementBtn,
    #decrementBtn,
    #deleteBtn,
    #customizeBtn,
    #completeOrderBtn {
      font-size: 14px;
      padding: 10px 15px;
      background-color: #6c757d;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 5px;
    }
    #clearInputBtn {
      background-color: #adb5bd;
    }
    #deleteBtn {
      background-color: #dc3545;
    }
    #completeOrderBtn {
      background-color: #495057;
      margin-top: 10px;
    }

    /* ========= 表格樣式 ========= */
    #orderTable {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #e9ecef;
    }

    /* ========= 總金額樣式 ========= */
    #totalPrice {
      font-weight: bold;
      font-size: 16px;
    }

    /* ========= 手機瀏覽器優化 ========= */
    @media (max-width: 600px) {
      main {
        margin: 10px;
        padding: 15px;
      }
      h1, h2 {
        font-size: 18px;
        margin-bottom: 15px;
      }
      label {
        font-size: 16px;
      }
      #inputTextArea {
        font-size: 14px;
      }
      #orderTable {
        font-size: 13px;
      }
      #totalPrice {
        font-size: 14px;
      }
      button {
        font-size: 13px;
        padding: 8px 10px;
      }
    }

    /* ========= Modal客製視窗 ========= */
    #customizeModal {
      display: none; /* 預設隱藏 */
      position: fixed; 
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #modalContent {
      background: #fff;
      padding: 20px;
      border-radius: 5px;
      max-width: 300px;
      margin: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .option-btns {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }
    .option-btn {
      background-color: #ccc;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .option-btn.active {
      background-color: #6c757d; 
      color: #fff;
    }
    /* 數量輸入(帶+ - 按鈕) */
    .qty-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      gap: 5px;
    }
    #minusQtyBtn,
    #plusQtyBtn {
      background-color: #adb5bd;
      border: none;
      padding: 5px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    #qtyInput {
      width: 60px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 4px;
      font-size: 14px;
    }
    #modalBtns {
      display: flex;
      gap: 10px;
    }
    #confirmBtn, #cancelBtn {
      background-color: #6c757d;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
    }
    #cancelBtn {
      background-color: #adb5bd;
    }
  </style>
</head>
<body>

  <main>
    <!-- ====== 輸入區域 ====== -->
    <label for="inputTextArea">點餐內容:</label>
    <textarea id="inputTextArea" placeholder="點擊後入開啟語音輸入..."></textarea>
    <br/>
    <button id="voiceBtn" onclick="startVoiceInput()">開始語音輸入</button>
    <button id="clearInputBtn" onclick="clearInputArea()">清除點餐</button>
    
    <!-- 操作功能鍵（在表格外） -->
    <h2>餐點清單:</h2>
    <div>
      <button id="incrementBtn" onclick="incrementSelected()">+</button>
      <button id="decrementBtn" onclick="decrementSelected()">-</button>
      <button id="deleteBtn" onclick="deleteSelected()">刪除</button>
      <button id="customizeBtn" onclick="customizeSelected()">客製</button>
    </div>

    <!-- ====== 表格 ====== -->
    <table id="orderTable">
      <thead>
        <tr>
          <th>選擇</th>
          <th>餐點名稱</th>
          <th>單價</th>
          <th>數量</th>
          <th>備註</th> <!-- 顯示「X份辣」+自訂文字 -->
        </tr>
      </thead>
      <tbody id="orderTableBody"></tbody>
    </table>

    <!-- 總金額 & 完成訂單 -->
    <div>總金額：<span id="totalPrice">0</span> 元</div>
    <button id="completeOrderBtn" onclick="completeOrder()">完成訂單</button>
  </main>

  <!-- ====== Modal: 客製視窗 ====== -->
  <div id="customizeModal">
    <div id="modalContent">
      <h3>客製化</h3>
      <div class="option-btns">
        <!-- 快捷按鈕：不、多、醋、蒜、菜 -->
        <button class="option-btn" data-value="不">不</button>
        <button class="option-btn" data-value="多">多</button>
        <button class="option-btn" data-value="醋">醋</button>
        <button class="option-btn" data-value="蒜">蒜</button>
        <button class="option-btn" data-value="菜">菜</button>
        <button class="option-btn" data-value="辣">辣</button>
      </div>

      <!-- 數量輸入欄位，帶 + - 按鈕 -->
      <div class="qty-row">
        <button id="minusQtyBtn" type="button">-</button>
        <input id="qtyInput" type="number" step="1" min="0" value="0" />
        <button id="plusQtyBtn" type="button">+</button>
      </div>

      <div id="modalBtns">
        <button id="confirmBtn">確定</button>
        <button id="cancelBtn">取消</button>
      </div>
    </div>
  </div>

  <script>
    /************************************
     * 全域變數與商品定義
     ************************************/
    var orderList = [];
    var itemPrices = {
      "芝麻蔥油餅": 20,
      "蔥油餅加蛋": 30,
      "芝麻蔥油餅": 20,
      "蔥油餅加蛋": 30,
      "蛋餅加荷包蛋": 45,
      "大腸麵線": 50,
      "肉羹麵線": 50,
      "綜合麵線": 50,
      "清麵線": 40,
      "純麵線": 40,
      "大炒麵": 40,
      "小炒麵": 30,
      "荷包蛋": 15,
      "貢丸湯": 35,
      "肉羹湯": 35,
      "綜合湯": 35,  
      "紅茶": 10,            
      "奶茶": 15,
      "豆漿": 15,
      "米漿": 15,




    };
    var homophones = {
      "麵": ["面", "念", "唸"],
      "線": ["鮮"],
      "綜": ["中"],
      "辣": ["拉","那","啦","納"],
      "合": ["和"],            
      "清": ["青","金","新","稀"],
      "炒": ["草", "早", "找","島"],
      "芝麻蔥油餅": ["蔥油餅", "不加蛋","附加蛋"],
      "蔥油餅加蛋": ["蛋餅", "加蛋"],
      "蛋餅加荷包蛋": ["蛋蔥油餅加蛋"],
      "大腸麵線": ["大腸","大腸麵線麵線","大堂","大唐"],
      "綜合湯": ["綜合麵線湯"],
      "綜合麵線": ["綜合","綜合麵線麵線"],
      "肉羹麵線": ["肉羹","肉羹麵線麵線"],
      "肉羹湯": ["肉羹麵線湯"],
      "清麵線": ["清","清麵線麵線"],
      "純麵線": ["純","純麵線麵線"],
      "大炒麵": ["大炒","大炒麵麵","炒麵","稻草"],
      "小炒麵": ["小炒","小大炒麵麵"], 
      "荷包蛋": ["荷8蛋"],         
      "份": ["碗", "杯", "個","玩","顆","婉","晚","分","噸","完","瓦"],
      "1": ["一", "億"],
      "2": ["兩", "量","涼"],
      "3": ["三", "參","山"],
      "4": ["四", "是","試"],
      "5": ["五", "無", "午"],
      "6": ["六", "溜"],
      "7": ["七", "妻"],
      "8": ["八", "咖", "包"],
      "9": ["九", "酒"],
      "10": ["十", "時"]

    };

    // 用來紀錄目前要客製的品項索引(多選)
    var currentCustomizeIndexes = [];

    /************************************
     * 文字分析(含「整份辣」 & 「部分辣」)
     ************************************/
    function analyzeText() {
      var inputText = document.getElementById("inputTextArea").value;

      // (A) 同音字替換
      for (var homophone in homophones) {
        var synonyms = homophones[homophone];
        for (var i = 0; i < synonyms.length; i++) {
          var pattern = new RegExp(synonyms[i], "g");
          inputText = inputText.replace(pattern, homophone);
        }
      }

      var newItems = [];

      // (B1) 「部分辣」: 商品N份M份辣 (如 "蔥油餅加蛋3份2份辣")
      for (var itemName in itemPrices) {
        var partialSpicyPattern = new RegExp(itemName + "(\\d+)份(\\d+)份辣", "g");
        inputText = inputText.replace(partialSpicyPattern, function(match, totalStr, spicyStr) {
          var total = parseInt(totalStr);
          var spicyCount = parseInt(spicyStr);
          addOrUpdateItem(newItems, itemName, total, spicyCount);
          return "";
        });
      }

      // (B2) 「整份辣」: 商品N份辣 (如 "蔥油餅加蛋3份辣") => 全部辣
      //   quantity=N, spicy=N
      for (var itemName in itemPrices) {
        var allSpicyPattern = new RegExp(itemName + "(\\d+)份辣", "g");
        inputText = inputText.replace(allSpicyPattern, function(match, qtyStr) {
          var total = parseInt(qtyStr);
          addOrUpdateItem(newItems, itemName, total, total); 
          // 將 spicy=quantity, 代表全部辣
          return "";
        });
      }

      // (C) 一般 => "N份商品" or "商品N份"
      for (var itemName in itemPrices) {
        // ex: "2份芝麻蔥油餅"
        var pattern1 = new RegExp("(\\d+)份" + itemName, "g");
        inputText = inputText.replace(pattern1, function(match, qtyStr) {
          addOrUpdateItem(newItems, itemName, parseInt(qtyStr), 0);
          return "";
        });

        // ex: "芝麻蔥油餅2份"
        var pattern2 = new RegExp(itemName + "(\\d+)份", "g");
        inputText = inputText.replace(pattern2, function(match, qtyStr) {
          addOrUpdateItem(newItems, itemName, parseInt(qtyStr), 0);
          return "";
        });
      }

      // (D) 通用: "N份 + XXX"
      var iPattern = new RegExp("(\\d+)份([\\s\\S]*?)", "g");
      inputText = inputText.replace(iPattern, function(match, qtyStr, possibleItemName) {
        if (itemPrices[possibleItemName]) {
          addOrUpdateItem(newItems, possibleItemName, parseInt(qtyStr), 0);
        }
        return "";
      });

      // 合併到全域 orderList
      mergeToOrderList(newItems);
      updateOrderTable();
    }

    // 建立或更新 newItems
    function addOrUpdateItem(newItems, name, qty, spicyQty) {
      var existing = newItems.find(function(x) {
        return x.name === name;
      });
      if (existing) {
        existing.quantity += qty;
        existing.spicy += spicyQty;
      } else {
        newItems.push({
          name: name,
          price: itemPrices[name],
          quantity: qty,
          spicy: spicyQty,
          remark: ""
        });
      }
    }

    // 與 orderList 合併
    // 若發現同名、且 remark=空，則累加
    function mergeToOrderList(newItems) {
      newItems.forEach(function(newItem) {
        var existing = orderList.find(function(o) {
          return o.name === newItem.name && o.remark === "";
        });
        if (existing) {
          existing.quantity += newItem.quantity;
          existing.spicy += newItem.spicy;
        } else {
          orderList.push(newItem);
        }
      });
    }

    /************************************
     * 表格渲染
     ************************************/
    function updateOrderTable(checkedIndexes) {
      var tableBody = document.getElementById("orderTableBody");
      tableBody.innerHTML = "";

      orderList.forEach(function(item, index) {
        var row = tableBody.insertRow();

        // (1) 勾選
        var selectCell = row.insertCell(0);
        var checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.classList.add("selectItem");
        checkbox.dataset.index = index;
        if (checkedIndexes && checkedIndexes.indexOf(index) !== -1) {
          checkbox.checked = true;
        }
        selectCell.appendChild(checkbox);

        // (2) 餐點名稱
        var nameCell = row.insertCell(1);
        nameCell.textContent = item.name;

        // (3) 單價
        var priceCell = row.insertCell(2);
        priceCell.textContent = item.price;

        // (4) 數量
        var qtyCell = row.insertCell(3);
        qtyCell.textContent = item.quantity;

        // (5) 備註(顯示「X份辣」+ remark)
        var remarkCell = row.insertCell(4);
        remarkCell.textContent = buildRemarkText(item);
      });

      updateTotalPrice();
    }

    // 將 partial-lat (spicy) & remark 整合顯示
    // 並處理「不/多 + 醋/蒜/菜」合併
    function buildRemarkText(item) {
      var parts = [];

      // 1) 若 spicy>0 => "X份辣"
      if (item.spicy > 0) {
        parts.push(item.spicy + "份辣");
      }

      // 2) 預設多次客製輸入以「 / 」分隔
      if (item.remark) {
        var remarkSegments = item.remark.split(" / ");
        var finalSegments = remarkSegments.map(seg => mergeNoMore(seg));
        parts.push(finalSegments.join(" / "));
      }
      return parts.join(", ");
    }

    // 合併「不+醋=>不醋」、「多+菜=>多菜」
    function mergeNoMore(remarkLine) {
      // ex: "不 醋 x3" -> "不醋 x3"
      var line = remarkLine.replace(/[，,]/g, " ");
      var tokens = line.trim().split(/\s+/);
      var result = [];
      for (var i=0; i<tokens.length; i++){
        var t = tokens[i];
        if ((t==="不" || t==="多") && i<tokens.length-1){
          var next = tokens[i+1];
          if(["醋","蒜","菜"].includes(next)){
            result.push(t+next); // "不+蒜" => "不蒜"
            i++;
            continue;
          }
        }
        result.push(t);
      }
      return result.join(" ");
    }

    function updateTotalPrice() {
      var total = orderList.reduce(function(acc, item) {
        return acc + (item.price * item.quantity);
      }, 0);
      document.getElementById("totalPrice").textContent = total;
    }

    /************************************
     * 操作功能鍵
     ************************************/
    // (A) 增加
    function incrementSelected() {
      var selectedIndexes = getSelectedIndexes();
      selectedIndexes.forEach(function(i) {
        orderList[i].quantity++;
      });
      updateOrderTable(selectedIndexes);
    }

    // (B) 減少
    function decrementSelected() {
      var selectedIndexes = getSelectedIndexes();
      selectedIndexes.forEach(function(i) {
        if (orderList[i].quantity > 1) {
          orderList[i].quantity--;
        }
      });
      updateOrderTable(selectedIndexes);
    }

    // (C) 刪除
    function deleteSelected() {
      var selectedIndexes = getSelectedIndexes().sort(function(a,b){return b-a;});
      selectedIndexes.forEach(function(i) {
        orderList.splice(i, 1);
      });
      updateOrderTable();
    }

    // (D) 客製
    function customizeSelected() {
      var selectedIndexes = getSelectedIndexes();
      if (selectedIndexes.length === 0) {
        alert("請先勾選要客製化的餐點！");
        return;
      }
      currentCustomizeIndexes = selectedIndexes;
      openCustomizeModal();
    }

    function getSelectedIndexes() {
      var checkboxes = document.querySelectorAll(".selectItem:checked");
      var indexes = [];
      checkboxes.forEach(function(chk) {
        indexes.push(parseInt(chk.dataset.index));
      });
      return indexes;
    }

    /************************************
     * 清除 & 完成訂單
     ************************************/
    function clearInputArea() {
      document.getElementById("inputTextArea").value = "";
    }
    function completeOrder() {
      orderList = [];
      document.getElementById("orderTableBody").innerHTML = "";
      document.getElementById("totalPrice").textContent = "0";
      document.getElementById("inputTextArea").value = "";
    }

    /************************************
     * 語音輸入
     ************************************/
    function startVoiceInput() {
      document.getElementById("inputTextArea").value = "";
      var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("您的瀏覽器不支援語音識別功能，請使用最新的Chrome或Edge瀏覽器。");
        return;
      }
      var recognition = new SpeechRecognition();
      recognition.lang = "zh-TW";
      recognition.onresult = function(event) {
        var transcript = event.results[0][0].transcript;
        document.getElementById("inputTextArea").value = transcript;
        analyzeText();
      };
      recognition.onerror = function(event) {
        console.error("語音識別錯誤:", event.error);
        var errorMessage = "語音識別錯誤，請重試。";
        switch (event.error) {
          case "no-speech":
            errorMessage = "未偵測到語音，請再試一次。";
            break;
          case "audio-capture":
            errorMessage = "未能捕獲音頻，請檢查麥克風是否已啟用。";
            break;
          case "not-allowed":
            errorMessage = "語音識別被阻止，請檢查瀏覽器權限設置。";
            break;
        }
        alert(errorMessage);
      };
      recognition.start();
    }

    /************************************
     * Modal: 客製視窗控制
     ************************************/
    var customizeModal = document.getElementById("customizeModal");
    var optionButtons = document.querySelectorAll(".option-btn");
    var qtyInput = document.getElementById("qtyInput");
    var minusQtyBtn = document.getElementById("minusQtyBtn");
    var plusQtyBtn = document.getElementById("plusQtyBtn");

    function openCustomizeModal() {
      // 重置所有快捷按鈕
      optionButtons.forEach(btn => btn.classList.remove("active"));
      // 數量歸零
      qtyInput.value = "0";
      // 顯示
      customizeModal.style.display = "flex";
    }
    function closeCustomizeModal() {
      customizeModal.style.display = "none";
    }

    // 快捷按鈕點擊 => 切換 active
    optionButtons.forEach(btn => {
      btn.addEventListener("click", function() {
        this.classList.toggle("active");
      });
    });

    // 數量欄 + -
    minusQtyBtn.addEventListener("click", function() {
      var val = parseInt(qtyInput.value || "0");
      if (val > 0) {
        qtyInput.value = val - 1;
      }
    });
    plusQtyBtn.addEventListener("click", function() {
      var val = parseInt(qtyInput.value || "0");
      qtyInput.value = val + 1;
    });

    // 「確定」: 將新的客製需求加到備註中(多次可累加)
    document.getElementById("confirmBtn").addEventListener("click", function() {
      // 1) 收集勾選的快捷字
      var selectedOpts = [];
      optionButtons.forEach(btn => {
        if (btn.classList.contains("active")) {
          selectedOpts.push(btn.dataset.value);
        }
      });
      // 2) 取得數量
      var numberVal = qtyInput.value.trim();
      // 3) 組合 remark
      var remarkArr = [];
      if (selectedOpts.length > 0) {
        remarkArr.push(selectedOpts.join(" "));
      }
      if (numberVal && numberVal !== "0") {
        remarkArr.push("x" + numberVal);
      }
      var newRemark = remarkArr.join(" ");

      // 4) 套用到被勾選的品項 => 累加 (以 " / " 分隔)
      currentCustomizeIndexes.forEach(i => {
        if (newRemark) {
          if (orderList[i].remark) {
            orderList[i].remark += " / " + newRemark;
          } else {
            orderList[i].remark = newRemark;
          }
        }
      });

      updateOrderTable(currentCustomizeIndexes);
      closeCustomizeModal();
    });
    document.getElementById("cancelBtn").addEventListener("click", function() {
      closeCustomizeModal();
    });

    // 點擊背景關閉
    customizeModal.addEventListener("click", function(e) {
      if (e.target.id === "customizeModal") {
        closeCustomizeModal();
      }
    });
  </script>
</body>
</html>
