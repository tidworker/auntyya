<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Order 頁面 - 學習功能 & 「客製」欄位</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 12px;
    }
    .section {
      border: 1px solid #ccc;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    button {
      margin: 5px 5px 5px 0;
      cursor: pointer;
    }
    .output {
      margin-top: 10px;
      color: #333;
    }
    .error {
      color: red;
    }
    .highlight {
      color: green;
      font-weight: bold;
    }
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }
    #order-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #order-table th, #order-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    @media (max-width: 600px) {
      body {
        margin: 10px;
      }
      .section {
        padding: 10px;
      }
      #order-table th, #order-table td {
        padding: 6px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

<h1>Order 頁面 - 學習功能 &「客製」欄位</h1>

<!-- 語音點餐 -->
<div class="section">
  <h2>語音點餐</h2>
  <button id="voice-input-btn">語音輸入</button>
  <div class="output" id="voice-output"></div>
</div>

<!-- 點餐輸入 -->
<div class="section">
  <h2>點餐 (含客製)</h2>
  <label for="order-input">請輸入餐點 + 客製內容:</label>
  <input type="text" id="order-input" placeholder="例如：我要2份漢堡加大辣">
  <button id="order-btn">點餐</button>
  <div class="output" id="order-output"></div>
</div>

<!-- 訂單表格 -->
<div class="section">
  <h2>已點清單</h2>
  <div class="table-wrapper">
    <table id="order-table">
      <thead>
        <tr>
          <th>餐點名稱</th>
          <th>客製</th> <!-- 原本「客製詞」改為「客製」 -->
          <th>數量</th>
          <th>單價</th>
          <th>小計</th>
        </tr>
      </thead>
      <tbody>
        <!-- 產生訂單列 -->
      </tbody>
    </table>
  </div>
  <h3>總金額：<span id="total-amount">0</span></h3>
</div>

<script>
/**
 * 1. 從 localStorage 讀取已學習的 menuItems / customWords (與主頁面共享)
 */
let menuItems = JSON.parse(localStorage.getItem("menuItems")) || [];
let customWords = JSON.parse(localStorage.getItem("customWords")) || [];

/* 儲存回 localStorage */
function saveMenuItems() {
  localStorage.setItem("menuItems", JSON.stringify(menuItems));
}

/* 2. DOM 取得 */
const voiceInputBtn = document.getElementById("voice-input-btn");
const orderInput = document.getElementById("order-input");
const orderBtn = document.getElementById("order-btn");
const orderOutput = document.getElementById("order-output");
const voiceOutput = document.getElementById("voice-output");

const orderTableBody = document.querySelector("#order-table tbody");
const totalAmountSpan = document.getElementById("total-amount");

/* 3. 紀錄總金額 */
let grandTotal = 0;

/* -------------------------------
   4. 語音輸入 (Web Speech API)
------------------------------- */
voiceInputBtn.addEventListener("click", () => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("您的瀏覽器不支援語音辨識，請使用 Chrome / Edge 等。");
    return;
  }
  const recognition = new SpeechRecognition();
  recognition.lang = "zh-TW";
  recognition.interimResults = false;
  
  recognition.onstart = () => {
    voiceOutput.textContent = "語音辨識中，請開始說話...";
    voiceOutput.classList.remove("error");
  };
  recognition.onerror = (evt) => {
    voiceOutput.textContent = "語音辨識錯誤：" + evt.error;
    voiceOutput.classList.add("error");
  };
  recognition.onresult = (evt) => {
    const transcript = evt.results[0][0].transcript;
    orderInput.value = transcript;
    voiceOutput.textContent = "語音輸入結果：" + transcript;
  };
  recognition.start();
});

/* -------------------------------
   5. 點餐按鈕
------------------------------- */
orderBtn.addEventListener("click", handleOrderInput);

function handleOrderInput() {
  const userInput = orderInput.value.trim();
  orderOutput.innerHTML = "";
  if (!userInput) {
    orderOutput.textContent = "請輸入想點的餐點 (可含客製)";
    orderOutput.classList.add("error");
    return;
  }
  orderOutput.classList.remove("error");

  // 先解析主要餐點數量
  const mainQty = parseQuantity(userInput);

  // 查找餐點 (先做部分比對)
  let matchedItems = findPartialMatches(userInput);

  if (matchedItems.length === 1) {
    // 唯一匹配 -> 直接加入
    const item = matchedItems[0];
    addOrderItem(item, mainQty, userInput);
  } else if (matchedItems.length === 0) {
    // 無匹配 -> 手動選擇 + 學習
    askUserToSelectItem(userInput, mainQty);
  } else {
    // 多筆 -> 這裡簡化處理，只提示多筆
    orderOutput.textContent = "找到多個相似餐點，請輸入更精確名稱！";
    orderOutput.classList.add("error");
  }

  orderInput.value = "";
}

/* -------------------------------
   6. 無匹配 -> 手動選擇 -> 學習
------------------------------- */
function askUserToSelectItem(userInput, mainQty) {
  orderOutput.innerHTML = `
    系統無法判定「<span class="highlight">${userInput}</span>」，請手動選擇餐點：<br>
  `;

  const selectElem = document.createElement("select");
  menuItems.forEach((item, idx) => {
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = `${item.name} (NT$${item.price})`;
    selectElem.appendChild(opt);
  });
  orderOutput.appendChild(selectElem);

  const confirmBtn = document.createElement("button");
  confirmBtn.textContent = "確認";
  confirmBtn.onclick = () => {
    const chosenIndex = parseInt(selectElem.value, 10);
    const chosenItem = menuItems[chosenIndex];
    // 將 userInput 當該餐點的新 synonym
    if (!chosenItem.synonyms.includes(userInput)) {
      chosenItem.synonyms.push(userInput);
      saveMenuItems();
    }
    // 然後直接加入訂單
    addOrderItem(chosenItem, mainQty, userInput);
  };
  orderOutput.appendChild(confirmBtn);
}

/* -------------------------------
   7. 新增一筆至訂單表格
   同時偵測「客製詞」(customWords) 並顯示於「客製」欄
------------------------------- */
function addOrderItem(item, mainQty, userInput) {
  // 偵測客製詞
  const customData = parseAllCustomWords(userInput);
  const customText = formatCustomData(customData); // e.g. "辣(1)、少糖(2)"

  // 計算小計
  const sub = item.price * mainQty;

  // 檢查表格中是否已有該餐點
  const existingRow = findRowByName(item.name);
  if (existingRow) {
    // 更新數量 & 小計 & 客製
    const qtyCell = existingRow.querySelector(".cell-qty");
    const subCell = existingRow.querySelector(".cell-subtotal");
    const customCell = existingRow.querySelector(".cell-custom");

    const oldQty = parseInt(qtyCell.textContent, 10) || 0;
    const newQty = oldQty + mainQty;

    qtyCell.textContent = newQty;

    const oldSub = parseInt(subCell.textContent, 10) || 0;
    const newSub = item.price * newQty;
    subCell.textContent = newSub;

    // 覆蓋或合併客製；這裡示範直接「以最新一次為主」，也可做累加
    customCell.textContent = customText;

    // 更新總金額
    grandTotal = grandTotal - oldSub + newSub;
  } else {
    // 新增一行
    const tr = document.createElement("tr");

    // 餐點名稱
    const tdName = document.createElement("td");
    tdName.textContent = item.name;
    tr.appendChild(tdName);

    // 客製 (改為「客製」欄)
    const tdCustom = document.createElement("td");
    tdCustom.classList.add("cell-custom");
    tdCustom.textContent = customText;
    tr.appendChild(tdCustom);

    // 數量
    const tdQty = document.createElement("td");
    tdQty.classList.add("cell-qty");
    tdQty.textContent = mainQty;
    tr.appendChild(tdQty);

    // 單價
    const tdPrice = document.createElement("td");
    tdPrice.textContent = item.price;
    tr.appendChild(tdPrice);

    // 小計
    const tdSub = document.createElement("td");
    tdSub.classList.add("cell-subtotal");
    tdSub.textContent = sub;
    tr.appendChild(tdSub);

    orderTableBody.appendChild(tr);
    grandTotal += sub;
  }
  // 更新總金額
  totalAmountSpan.textContent = grandTotal;

  // 顯示提示
  orderOutput.innerHTML = `
    已為您加入 <span class="highlight">${mainQty}</span> 份
    <span class="highlight">${item.name}</span>，
    客製：<span class="highlight">${customText || "無"}</span>，
    小計：NT$${sub}
  `;
}

/* -------------------------------
   幫助函式：找表格中有無該餐點
------------------------------- */
function findRowByName(itemName) {
  const rows = orderTableBody.querySelectorAll("tr");
  for (let row of rows) {
    const nameCell = row.querySelector("td:first-child");
    if (nameCell && nameCell.textContent === itemName) {
      return row;
    }
  }
  return null;
}

/* -------------------------------
   偵測所有客製詞(含數量)
   若要做份數 -> parseCustomWordQuantity
   這裡示範簡易: 若 userInput.includes(word) => customData[word] = 1
------------------------------- */
function parseAllCustomWords(userInput) {
  let result = {};
  for (let w of customWords) {
    if (userInput.includes(w)) {
      // 此示範只做 presence，不解析數量 → 皆為1
      // 如需解析 "兩份辣" => parseCustomWordQuantity
      result[w] = 1;
    }
  }
  return result;
}
/* 將 { "辣":2, "少糖":1 } => "辣(2)、少糖(1)" */
function formatCustomData(customObj) {
  const parts = [];
  for (let key in customObj) {
    parts.push(`${key}(${customObj[key]})`);
  }
  return parts.join("、");
}

/* -------------------------------
   解析主要份數 (簡易)
------------------------------- */
function parseQuantity(input) {
  // 先試阿拉伯數字
  const m1 = input.match(/(\d+)\s*(份|顆|個|杯|碗|串)?/);
  if (m1) {
    const q = parseInt(m1[1], 10);
    if (!isNaN(q)) return q;
  }
  // 再試中文
  const m2 = input.match(/[零一二兩三四五六七八九十]+/);
  if (m2) {
    const val = convertChineseNumberToInt(m2[0]);
    if (val > 0) return val;
  }
  // 預設1
  return 1;
}

/* -------------------------------
   convertChineseNumberToInt (1~99)
------------------------------- */
function convertChineseNumberToInt(cnStr) {
  const cnMap = {
    '零': 0, '一': 1, '二': 2, '兩': 2, '三': 3,
    '四': 4, '五': 5, '六': 6, '七': 7,
    '八': 8, '九': 9
  };
  if (cnStr === '十') return 10;
  const parts = cnStr.split('十');
  if (parts.length === 1) {
    let sum = 0;
    for (let c of cnStr) {
      if (cnMap[c] != null) {
        sum = sum * 10 + cnMap[c];
      }
    }
    return sum;
  } else {
    let leftPart = parts[0];
    let rightPart = parts[1] || "";
    let leftVal = 0;
    if (leftPart === '') {
      leftVal = 1;
    } else {
      let sum = 0;
      for (let c of leftPart) {
        if (cnMap[c] != null) {
          sum = sum * 10 + cnMap[c];
        }
      }
      leftVal = sum === 0 ? 1 : sum;
    }
    let rightVal = 0;
    if (rightPart !== '') {
      let sum2 = 0;
      for (let c of rightPart) {
        if (cnMap[c] != null) {
          sum2 = sum2 * 10 + cnMap[c];
        }
      }
      rightVal = sum2;
    }
    return leftVal * 10 + rightVal;
  }
}

/* -------------------------------
   查找「部分比對」
------------------------------- */
function findPartialMatches(userInput) {
  const results = [];
  for (let item of menuItems) {
    for (let syn of item.synonyms) {
      if (userInput.includes(syn)) {
        results.push(item);
        break;
      }
    }
  }
  return results;
}
</script>

</body>
</html>