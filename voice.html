<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>獨立點餐系統 (使用已學習的資料庫)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 12px;
    }
    .section {
      border: 1px solid #ccc;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    label {
      display: inline-block;
      width: 90px;
      margin-right: 5px;
    }
    button {
      margin: 5px 5px 5px 0;
      cursor: pointer;
    }
    #order-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #order-table th, #order-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    .output {
      margin-top: 10px;
      color: #333;
    }
    .error {
      color: red;
    }
    .highlight {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>獨立點餐系統 (使用已學習的資料庫)</h1>

<!-- 點餐 (使用語音) -->
<div class="section">
  <h2>語音點餐</h2>
  <div>
    <button id="voice-input-btn">語音輸入</button>
  </div>
  <div class="output" id="voice-output"></div>
</div>

<!-- 已點清單 (表格) -->
<div class="section">
  <h2>已點餐點</h2>
  <table id="order-table">
    <thead>
      <tr>
        <th>餐點名稱</th>
        <th>數量</th>
        <th>單價</th>
        <th>小計</th>
      </tr>
    </thead>
    <tbody>
      <!-- 動態產生 -->
    </tbody>
  </table>
</div>

<script>
// 1. 讀取 LocalStorage 中的 menuItems (與原先學習頁使用同一key)
let menuItems = JSON.parse(localStorage.getItem("menuItems")) || [];

// 2. DOM 取得
const voiceInputBtn = document.getElementById("voice-input-btn");
const voiceOutput = document.getElementById("voice-output");
const orderTableBody = document.querySelector("#order-table tbody");

// 3. 語音輸入
voiceInputBtn.addEventListener("click", () => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("您的瀏覽器不支援語音辨識。請使用 Chrome 或其他支援的瀏覽器。");
    return;
  }
  const recognition = new SpeechRecognition();
  recognition.lang = "zh-TW";
  recognition.interimResults = false;

  recognition.onstart = () => {
    voiceOutput.textContent = "語音辨識中，請開始說話...";
    voiceOutput.classList.remove("error");
  };
  recognition.onerror = (e) => {
    voiceOutput.textContent = "語音辨識錯誤：" + e.error;
    voiceOutput.classList.add("error");
  };
  recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    voiceOutput.textContent = "語音輸入結果：" + transcript;
    voiceOutput.classList.remove("error");

    // 解析並自動點餐
    handleOrderByInput(transcript.trim());
  };
  recognition.start();
});

// 4. 根據輸入內容判斷餐點並自動顯示於表格
function handleOrderByInput(userInput) {
  if (!userInput) {
    voiceOutput.textContent = "未偵測到任何語音輸入。";
    voiceOutput.classList.add("error");
    return;
  }

  // 解析份數(含簡易中文數字)
  const quantity = parseQuantity(userInput);

  // 嘗試部分比對(或完整比對) => 回傳所有可能符合的餐點
  const matched = findMatches(userInput);

  if (matched.length === 1) {
    // 唯一匹配 -> 直接加入表格
    const item = matched[0];
    const totalPrice = item.price * quantity;
    addTableRow(item.name, quantity, item.price, totalPrice);

    voiceOutput.textContent = `已自動辨識為「${item.name}」，數量: ${quantity}，小計: NT$${totalPrice}`;

  } else if (matched.length === 0) {
    // 0筆 => 無法判定
    voiceOutput.textContent = "無法匹配任何餐點，請重新輸入/說明。";
    voiceOutput.classList.add("error");
  } else {
    // 多筆 => 無法自動判定
    voiceOutput.textContent = "找到多筆符合，無法自動判定。請更精確描述。";
    voiceOutput.classList.add("error");
  }
}

// 5. 將項目新增至表格
function addTableRow(name, qty, price, total) {
  const tr = document.createElement("tr");

  const tdName = document.createElement("td");
  tdName.textContent = name;
  tr.appendChild(tdName);

  const tdQty = document.createElement("td");
  tdQty.textContent = qty;
  tr.appendChild(tdQty);

  const tdPrice = document.createElement("td");
  tdPrice.textContent = price;
  tr.appendChild(tdPrice);

  const tdTotal = document.createElement("td");
  tdTotal.textContent = total;
  tr.appendChild(tdTotal);

  orderTableBody.appendChild(tr);
}

// 6. 比對邏輯：若 userInput 包含某餐點的 synonym，即視為匹配
function findMatches(userInput) {
  // 可以先做 exact match 檢查 => 若只要 partial match，亦可直接 partial
  // 這裡為示範，直接做 "部分比對" (includes)
  const results = [];
  for (let item of menuItems) {
    // synonyms 可能包含多個字詞
    for (let syn of item.synonyms) {
      if (userInput.includes(syn)) {
        results.push(item);
        break;
      }
    }
  }
  return results;
}

// 7. 份數解析：支援阿拉伯數字 + 簡易中文 (1～99)
function parseQuantity(input) {
  // 先試阿拉伯數字
  const arabicMatch = input.match(/(\d+)\s*(份|顆|個|碗|杯|串)?/);
  if (arabicMatch) {
    const q = parseInt(arabicMatch[1], 10);
    if (!isNaN(q)) return q;
  }
  // 再試中文數字
  let str = input.replace(/(份|顆|個|碗|杯|串)/g, '');
  const cnMatch = str.match(/[零一二兩三四五六七八九十]+/);
  if (cnMatch) {
    const val = convertChineseNumberToInt(cnMatch[0]);
    if (val > 0) return val;
  }
  // 都沒有 => 預設 1
  return 1;
}

function convertChineseNumberToInt(cnStr) {
  const cnMap = {
    '零': 0, '一': 1, '二': 2, '兩': 2, '三': 3,
    '四': 4, '五': 5, '六': 6, '七': 7,
    '八': 8, '九': 9
  };
  if (cnStr === '十') return 10;
  const parts = cnStr.split('十');
  if (parts.length === 1) {
    let sum = 0;
    for (let c of cnStr) {
      if (cnMap[c] != null) {
        sum = sum * 10 + cnMap[c];
      }
    }
    return sum;
  } else {
    let leftPart = parts[0];
    let rightPart = parts[1] || "";
    let leftVal = 0;
    if (leftPart === '') {
      leftVal = 1;
    } else {
      let sum = 0;
      for (let c of leftPart) {
        if (cnMap[c] != null) {
          sum = sum * 10 + cnMap[c];
        }
      }
      leftVal = sum === 0 ? 1 : sum;
    }
    let rightVal = 0;
    if (rightPart !== '') {
      let sum2 = 0;
      for (let c of rightPart) {
        if (cnMap[c] != null) {
          sum2 = sum2 * 10 + cnMap[c];
        }
      }
      rightVal = sum2;
    }
    return leftVal * 10 + rightVal;
  }
}
</script>

</body>
</html>