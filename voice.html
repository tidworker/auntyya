<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>點餐系統 - 多筆匹配選定後自動 & 重複項目加數量</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 12px;
    }
    .section {
      border: 1px solid #ccc;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    button {
      margin: 5px 5px 5px 0;
      cursor: pointer;
    }
    .output {
      margin-top: 10px;
      color: #333;
    }
    .error {
      color: red;
    }
    .highlight {
      color: green;
      font-weight: bold;
    }

    /* 表格: RWD 支援 */
    .table-wrapper {
      width: 100%;
      overflow-x: auto; /* 小螢幕可左右捲動 */
    }
    #order-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #order-table th, #order-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    /* 簡易 Media Query */
    @media (max-width: 600px) {
      body {
        margin: 10px;
      }
      .section {
        padding: 10px;
      }
      #order-table th, #order-table td {
        padding: 6px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

<h1>點餐頁面 - 多筆匹配學習 & 重複品項合併</h1>

<!-- 語音點餐 -->
<div class="section">
  <h2>語音點餐</h2>
  <button id="voice-input-btn">語音輸入</button>
  <div class="output" id="voice-output"></div>
</div>

<!-- 已點清單 (含總金額) -->
<div class="section">
  <h2>已點餐點</h2>
  <div class="table-wrapper">
    <table id="order-table">
      <thead>
        <tr>
          <th>餐點名稱</th>
          <th>數量</th>
          <th>單價</th>
          <th>小計</th>
        </tr>
      </thead>
      <tbody>
        <!-- 動態列 -->
      </tbody>
    </table>
  </div>
  <h3>總金額：<span id="total-amount">0</span></h3>
</div>

<script>
// --------------------------------------------------
// 1. 從 localStorage 讀取已學習的餐點資料
// --------------------------------------------------
let menuItems = JSON.parse(localStorage.getItem("menuItems")) || [];

// --------------------------------------------------
// 2. DOM 取得
// --------------------------------------------------
const voiceInputBtn = document.getElementById("voice-input-btn");
const voiceOutput = document.getElementById("voice-output");
const orderTableBody = document.querySelector("#order-table tbody");
const totalAmountSpan = document.getElementById("total-amount");

// --------------------------------------------------
// 3. 紀錄總金額
// --------------------------------------------------
let grandTotal = 0;

// --------------------------------------------------
// 4. 語音輸入
// --------------------------------------------------
voiceInputBtn.addEventListener("click", () => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("您的瀏覽器不支援語音辨識。請使用 Chrome 或其他支援的瀏覽器。");
    return;
  }
  const recognition = new SpeechRecognition();
  recognition.lang = "zh-TW";
  recognition.interimResults = false;

  recognition.onstart = () => {
    voiceOutput.textContent = "語音辨識中，請開始說話...";
    voiceOutput.classList.remove("error");
  };
  recognition.onerror = (e) => {
    voiceOutput.textContent = "語音辨識錯誤：" + e.error;
    voiceOutput.classList.add("error");
  };
  recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    voiceOutput.textContent = "語音輸入結果：" + transcript;
    voiceOutput.classList.remove("error");

    // 解析並點餐
    handleOrderByInput(transcript.trim());
  };
  recognition.start();
});

// --------------------------------------------------
// 5. 根據使用者輸入去判定餐點
// --------------------------------------------------
function handleOrderByInput(userInput) {
  if (!userInput) {
    voiceOutput.textContent = "未偵測到任何語音輸入。";
    voiceOutput.classList.add("error");
    return;
  }

  const quantity = parseQuantity(userInput);

  // 先檢查「完整字串」(exact match)
  const exactMatches = findExactMatches(userInput);
  if (exactMatches.length === 1) {
    // 唯一完整字串匹配 -> 直接加
    addOrderItem(exactMatches[0], userInput, quantity);
    return;
  } else if (exactMatches.length > 1) {
    // 多筆完整 -> 暫時示範直接請使用者挑
    // (理論上較少出現，但如同 partial multi scenario)
    showMultipleMatches(exactMatches, userInput, quantity, true);
    return;
  }

  // 沒有(或多筆)完整字串 -> 進入「部分比對」
  const partialMatches = findPartialMatches(userInput);
  if (partialMatches.length === 1) {
    // 1 筆 partial -> 直接加 & 學習(將 userInput 放進 synonyms)
    addOrderItem(partialMatches[0], userInput, quantity);
  } else if (partialMatches.length === 0) {
    voiceOutput.textContent = "無法匹配任何餐點，請重新輸入。";
    voiceOutput.classList.add("error");
  } else {
    // 多筆 partial -> 顯示按鈕讓使用者選
    showMultipleMatches(partialMatches, userInput, quantity, false);
  }
}

// --------------------------------------------------
// 6. 多筆匹配 -> 使用者選正確餐點 -> 下次就會是 "exact match"
// --------------------------------------------------
function showMultipleMatches(items, userInput, quantity, isExactMode) {
  // isExactMode: 若在 "完整字串" 多筆匹配也可能發生
  voiceOutput.innerHTML = isExactMode
    ? "偵測到多筆『完整字串』相同，請選擇正確餐點：<br>"
    : "找到多筆『部分比對』符合，請選擇正確餐點：<br>";

  items.forEach(item => {
    const btn = document.createElement("button");
    btn.textContent = item.name;
    btn.onclick = () => {
      addOrderItem(item, userInput, quantity);
    };
    voiceOutput.appendChild(btn);
  });
}

// --------------------------------------------------
// 7. 加入餐點到訂單 (含學習 & 同品項合併數量)
// --------------------------------------------------
function addOrderItem(item, userInput, quantity) {
  // (a) 若 userInput 尚未在 item.synonyms 裡，將其加入 => 下次成 exact match
  if (!item.synonyms.includes(userInput)) {
    item.synonyms.push(userInput);
    saveMenuItemsToLocalStorage();
  }

  // (b) 檢查表格中是否已存在該餐點 (依 name 判斷)
  const existingRow = findRowByName(item.name);
  const subtotal = item.price * quantity;

  if (existingRow) {
    // 如果已存在 -> 更新數量 & 小計
    const qtyCell = existingRow.querySelector(".cell-qty");
    const subCell = existingRow.querySelector(".cell-subtotal");

    const oldQty = parseInt(qtyCell.textContent, 10) || 0;
    const newQty = oldQty + quantity;
    qtyCell.textContent = newQty;

    const oldSub = parseInt(subCell.textContent, 10) || 0;
    const newSub = item.price * newQty;
    subCell.textContent = newSub;

    // 同時更新總金額 (先減去舊的小計，換算新的)
    grandTotal = grandTotal - oldSub + newSub;
  } else {
    // 不存在 -> 新增一筆
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.textContent = item.name;
    tr.appendChild(tdName);

    const tdQty = document.createElement("td");
    tdQty.classList.add("cell-qty");
    tdQty.textContent = quantity;
    tr.appendChild(tdQty);

    const tdPrice = document.createElement("td");
    tdPrice.textContent = item.price;
    tr.appendChild(tdPrice);

    const tdSubtotal = document.createElement("td");
    tdSubtotal.classList.add("cell-subtotal");
    tdSubtotal.textContent = subtotal;
    tr.appendChild(tdSubtotal);

    orderTableBody.appendChild(tr);

    // 更新 grandTotal
    grandTotal += subtotal;
  }

  // (c) 更新總金額 UI
  totalAmountSpan.textContent = grandTotal;

  // (d) 提示
  voiceOutput.innerHTML = `
    已加入 <span class="highlight">${quantity}</span> 份
    <span class="highlight">${item.name}</span> (單價: ${item.price})，
    小計: NT$${subtotal}
  `;
}

// --------------------------------------------------
// 8. 幫助函式: 找表格某 row(看 itemName) 有無出現
// --------------------------------------------------
function findRowByName(itemName) {
  const rows = orderTableBody.querySelectorAll("tr");
  for (let row of rows) {
    const nameCell = row.querySelector("td:first-child");
    if (nameCell && nameCell.textContent === itemName) {
      return row;
    }
  }
  return null;
}

// --------------------------------------------------
// 9. 儲存回 localStorage
// --------------------------------------------------
function saveMenuItemsToLocalStorage() {
  localStorage.setItem("menuItems", JSON.stringify(menuItems));
}

// --------------------------------------------------
// 10. 查找「完整字串」(exact) / 「部分比對」(partial)
// --------------------------------------------------
function findExactMatches(userInput) {
  // synonyms.includes(userInput)
  return menuItems.filter(item => item.synonyms.includes(userInput));
}
function findPartialMatches(userInput) {
  // userInput.includes(syn)
  const results = [];
  for (let item of menuItems) {
    for (let syn of item.synonyms) {
      if (userInput.includes(syn)) {
        results.push(item);
        break;
      }
    }
  }
  return results;
}

// --------------------------------------------------
// 11. 解析份數 (阿拉伯 + 簡易中文 1~99)
// --------------------------------------------------
function parseQuantity(input) {
  // (a) 先試阿拉伯數字
  const arabicMatch = input.match(/(\d+)\s*(份|顆|個|碗|杯|串)?/);
  if (arabicMatch) {
    const q = parseInt(arabicMatch[1], 10);
    if (!isNaN(q)) return q;
  }
  // (b) 再試中文數字
  let str = input.replace(/(份|顆|個|碗|杯|串)/g, '');
  const cnMatch = str.match(/[零一二兩三四五六七八九十]+/);
  if (cnMatch) {
    const val = convertChineseNumberToInt(cnMatch[0]);
    if (val > 0) return val;
  }
  // (c) 預設1
  return 1;
}
function convertChineseNumberToInt(cnStr) {
  const cnMap = {
    '零': 0, '一': 1, '二': 2, '兩': 2, '三': 3,
    '四': 4, '五': 5, '六': 6, '七': 7,
    '八': 8, '九': 9
  };
  if (cnStr === '十') return 10;
  const parts = cnStr.split('十');
  if (parts.length === 1) {
    let sum = 0;
    for (let c of cnStr) {
      if (cnMap[c] != null) {
        sum = sum * 10 + cnMap[c];
      }
    }
    return sum;
  } else {
    let leftPart = parts[0];
    let rightPart = parts[1] || "";
    let leftVal = 0;
    if (leftPart === '') {
      leftVal = 1;
    } else {
      let sum = 0;
      for (let c of leftPart) {
        if (cnMap[c] != null) {
          sum = sum * 10 + cnMap[c];
        }
      }
      leftVal = sum === 0 ? 1 : sum;
    }
    let rightVal = 0;
    if (rightPart !== '') {
      let sum2 = 0;
      for (let c of rightPart) {
        if (cnMap[c] != null) {
          sum2 = sum2 * 10 + cnMap[c];
        }
      }
      rightVal = sum2;
    }
    return leftVal * 10 + rightVal;
  }
}
</script>

</body>
</html>