<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>中文點餐系統</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      padding: 0;
    }
    input, button {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      cursor: pointer;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
    li:hover {
      background-color: #f0f0f0;
    }
    @media (max-width: 600px) {
      input, button { font-size: 18px; }
    }
    /* Modal 樣式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1>中文點餐系統</h1>

  <!-- 點餐區 -->
  <section>
    <h2>請輸入中文菜品名稱</h2>
    <input type="text" id="orderInput" placeholder="例如：蔥油餅">
    <button onclick="orderFromChinese()">送出訂單</button>
    <p>訂單結果：<span id="orderResult"></span></p>
  </section>

  <!-- 自動讀取轉譯字庫 -->
  <section>
    <h2>轉譯字庫載入狀態</h2>
    <p id="dbStatus">尚未載入字庫資料...</p>
  </section>

  <!-- 菜單管理區 -->
  <section>
    <h2>菜單管理</h2>
    <button onclick="openMenuModal()">新增菜單</button>
    <button onclick="downloadMenuData()">下載菜單資料</button>
    <button onclick="document.getElementById('uploadMenuFile').click()">上傳菜單資料</button>
    <input type="file" id="uploadMenuFile" accept=".txt" style="display:none;" onchange="uploadMenuData()">
    <div id="menuList"></div>
  </section>

  <!-- 新增/編輯菜單彈出視窗 -->
  <div id="menuModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeMenuModal()">&times;</span>
      <h3 id="modalTitle">新增菜單項目</h3>
      <div class="form-group">
        <label for="menuName">菜品名稱 (中文)：</label>
        <input type="text" id="menuName" placeholder="例如: 蔥油餅">
      </div>
      <div class="form-group">
        <label for="menuKey">點餐關鍵字 (英文)：</label>
        <input type="text" id="menuKey" placeholder="自動轉譯" readonly>
      </div>
      <div class="form-group">
        <label for="menuPrice">價格：</label>
        <input type="number" id="menuPrice" placeholder="例如: 20">
      </div>
      <button id="saveButton" onclick="saveMenuItem()">儲存</button>
      <button id="deleteButton" onclick="deleteMenuItem()" style="display:none; background-color:red; color:white;">刪除</button>
      <button onclick="closeMenuModal()">取消</button>
    </div>
  </div>

  <script>
    // 全域資料
    let groupMapping = {};
    let charMapping = {};
    let menu = {
      "chonyobin": { name: "蔥油餅", price: 20 }
    };
    let currentEditingKey = null; // 用於記錄正在編輯的菜單項目

    // 自動從同一伺服器的 database.txt 讀取字庫資料
    function loadTranslationDatabase() {
      fetch("database.txt")
        .then(response => {
          if (!response.ok) throw new Error("無法讀取 database.txt");
          return response.text();
        })
        .then(text => {
          const db = JSON.parse(text);
          if (db.groupMapping && db.charMapping) {
            groupMapping = db.groupMapping;
            charMapping = db.charMapping;
            document.getElementById("dbStatus").innerText = "字庫資料載入成功！";
          } else {
            document.getElementById("dbStatus").innerText = "database.txt 格式不正確！";
          }
        })
        .catch(err => {
          document.getElementById("dbStatus").innerText = "載入字庫資料失敗：" + err.message;
        });
    }
    loadTranslationDatabase();

    // 更新菜單顯示
    function updateMenuDisplay() {
      let menuListDiv = document.getElementById("menuList");
      menuListDiv.innerHTML = "";
      let ul = document.createElement("ul");
      for (let key in menu) {
        if (menu.hasOwnProperty(key)) {
          let li = document.createElement("li");
          li.textContent = key + " : " + menu[key].name + " - " + menu[key].price + "元";
          li.onclick = () => openMenuModal(key); // 點擊以編輯
          ul.appendChild(li);
        }
      }
      menuListDiv.appendChild(ul);
    }
    updateMenuDisplay();

    // 開啟新增或編輯菜單彈出視窗
    function openMenuModal(key = null) {
      const modal = document.getElementById("menuModal");
      modal.style.display = "block";
      currentEditingKey = key;

      if (key) {
        // 編輯模式
        document.getElementById("modalTitle").innerText = "編輯菜單項目";
        document.getElementById("menuName").value = menu[key].name;
        document.getElementById("menuKey").value = key;
        document.getElementById("menuPrice").value = menu[key].price;
        document.getElementById("deleteButton").style.display = "inline-block";
      } else {
        // 新增模式
        document.getElementById("modalTitle").innerText = "新增菜單項目";
        document.getElementById("menuName").value = "";
        document.getElementById("menuKey").value = "";
        document.getElementById("menuPrice").value = "";
        document.getElementById("deleteButton").style.display = "none";
      }
    }

    // 關閉彈出視窗
    function closeMenuModal() {
      document.getElementById("menuModal").style.display = "none";
      currentEditingKey = null;
    }

    // 儲存菜單項目（新增或編輯）
    function saveMenuItem() {
      const name = document.getElementById("menuName").value.trim();
      const key = document.getElementById("menuKey").value.trim().toLowerCase();
      const price = parseFloat(document.getElementById("menuPrice").value.trim());

      if (!key || !name || isNaN(price)) {
        alert("請填寫完整且正確的菜單資料！");
        return;
      }

      menu[key] = { name: name, price: price };
      updateMenuDisplay();
      closeMenuModal();
    }

    // 刪除菜單項目
    function deleteMenuItem() {
      if (currentEditingKey && confirm("確定要刪除該項目嗎？")) {
        delete menu[currentEditingKey];
        updateMenuDisplay();
        closeMenuModal();
      }
    }

    // 自動生成英文關鍵字
    document.getElementById("menuName").addEventListener("input", function () {
      let name = this.value.trim();
      let key = "";
      for (let i = 0; i < name.length; i++) {
        let ch = name.charAt(i);
        if (charMapping[ch] !== undefined) {
          key += charMapping[ch];
        }
      }
      document.getElementById("menuKey").value = key;
    });
  </script>
</body>
</html>