<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>中文點餐系統</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      padding: 0;
    }
    input, button {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      cursor: pointer;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
    li:hover {
      background-color: #f0f0f0;
    }
    @media (max-width: 600px) {
      input, button { font-size: 18px; }
    }
    /* Modal 樣式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1>中文點餐系統</h1>

  <!-- 點餐區 -->
  <section>
    <h2>請輸入中文菜品名稱</h2>
    <input type="text" id="orderInput" placeholder="例如：蔥油餅">
    <button onclick="orderFromChinese()">送出訂單</button>
    <p>訂單結果：<span id="orderResult"></span></p>
  </section>

  <!-- 自動讀取轉譯字庫 -->
  <section>
    <h2>轉譯字庫載入狀態</h2>
    <p id="dbStatus">尚未載入字庫資料...</p>
  </section>

  <!-- 菜單管理區 -->
  <section>
    <h2>菜單管理</h2>
    <button onclick="openMenuModal()">新增菜單</button>
    <button onclick="downloadMenuData()">下載菜單資料</button>
    <button onclick="document.getElementById('uploadMenuFile').click()">上傳菜單資料</button>
    <input type="file" id="uploadMenuFile" accept=".txt" style="display:none;" onchange="uploadMenuData()">
    <div id="menuList"></div>
  </section>

  <!-- 新增/編輯菜單彈出視窗 -->
  <div id="menuModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeMenuModal()">&times;</span>
      <h3 id="modalTitle">新增菜單項目</h3>
      <div class="form-group">
        <label for="menuName">菜品名稱 (中文)：</label>
        <input type="text" id="menuName" placeholder="例如: 蔥油餅">
      </div>
      <div class="form-group">
        <label for="menuKey">點餐關鍵字 (英文，可手動編輯)：</label>
        <input type="text" id="menuKey" placeholder="自動轉譯或手動輸入">
      </div>
      <div class="form-group">
        <label for="menuPrice">價格：</label>
        <input type="number" id="menuPrice" placeholder="例如: 20">
      </div>
      <button id="saveButton" onclick="saveMenuItem()">儲存</button>
      <button id="deleteButton" onclick="deleteMenuItem()" style="display:none; background-color:red; color:white;">刪除</button>
      <button onclick="closeMenuModal()">取消</button>
    </div>
  </div>

  <script>
    // 全域資料
    let groupMapping = {};
    let charMapping = {};
    let menu = {
      "chonyobin": { name: "蔥油餅", price: 20 }
    };
    let currentEditingKey = null;
    let manualEditKey = false; // 是否手動編輯英文關鍵字

    // 從同一伺服器讀取 database.txt 的轉譯資料
    function loadTranslationDatabase() {
      fetch("database.txt")
        .then(response => {
          if (!response.ok) throw new Error("無法讀取 database.txt");
          return response.text();
        })
        .then(text => {
          const db = JSON.parse(text);
          if (db.groupMapping && db.charMapping) {
            groupMapping = db.groupMapping;
            charMapping = db.charMapping;
            document.getElementById("dbStatus").innerText = "字庫資料載入成功！";
          } else {
            document.getElementById("dbStatus").innerText = "database.txt 格式不正確！";
          }
        })
        .catch(err => {
          document.getElementById("dbStatus").innerText = "載入字庫資料失敗：" + err.message;
        });
    }
    loadTranslationDatabase();

    // 更新菜單列表顯示
    function updateMenuDisplay() {
      const menuListDiv = document.getElementById("menuList");
      menuListDiv.innerHTML = "";
      const ul = document.createElement("ul");
      for (let key in menu) {
        if (menu.hasOwnProperty(key)) {
          const li = document.createElement("li");
          li.textContent = key + " : " + menu[key].name + " - " + menu[key].price + "元";
          li.onclick = () => openMenuModal(key);
          ul.appendChild(li);
        }
      }
      menuListDiv.appendChild(ul);
    }
    updateMenuDisplay();

    // 開啟新增或編輯菜單視窗
    function openMenuModal(key = null) {
      currentEditingKey = key; // key 為 null 代表新增模式
      const modal = document.getElementById("menuModal");
      modal.style.display = "block";
      manualEditKey = false;
      if (key) {
        // 編輯模式：填入原有資料
        document.getElementById("modalTitle").innerText = "編輯菜單項目";
        document.getElementById("menuName").value = menu[key].name;
        document.getElementById("menuKey").value = key;
        document.getElementById("menuPrice").value = menu[key].price;
        document.getElementById("deleteButton").style.display = "inline-block";
      } else {
        // 新增模式：清空所有欄位
        document.getElementById("modalTitle").innerText = "新增菜單項目";
        document.getElementById("menuName").value = "";
        document.getElementById("menuKey").value = "";
        document.getElementById("menuPrice").value = "";
        document.getElementById("deleteButton").style.display = "none";
      }
    }

    // 關閉菜單編輯視窗
    function closeMenuModal() {
      document.getElementById("menuModal").style.display = "none";
      currentEditingKey = null;
    }

    // 新增或更新菜單項目（編輯模式直接更新原資料）
    function saveMenuItem() {
      const name = document.getElementById("menuName").value.trim();
      let key = document.getElementById("menuKey").value.trim().toLowerCase();
      const price = parseFloat(document.getElementById("menuPrice").value.trim());
      if (!key || !name || isNaN(price)) {
        alert("請填寫完整且正確的菜單資料！");
        return;
      }
      if (currentEditingKey) {
        if (key !== currentEditingKey) {
          delete menu[currentEditingKey];
        }
      } else if (menu[key]) {
        alert("已有相同關鍵字的菜單項目！");
        return;
      }
      menu[key] = { name, price };
      updateMenuDisplay();
      closeMenuModal();
    }

    // 刪除菜單項目
    function deleteMenuItem() {
      if (currentEditingKey && confirm("確定要刪除該項目嗎？")) {
        delete menu[currentEditingKey];
        updateMenuDisplay();
        closeMenuModal();
      }
    }

    // 點餐功能：輸入中文後根據字庫轉譯英文，精確或模糊比對下單
    function orderFromChinese() {
      const input = document.getElementById("orderInput").value.trim();
      if (!input) {
        alert("請輸入中文菜品名稱！");
        return;
      }
      let converted = "";
      for (let i = 0; i < input.length; i++) {
        const ch = input.charAt(i);
        if (charMapping[ch] !== undefined) {
          converted += charMapping[ch];
        }
      }
      if (menu[converted]) {
        const dish = menu[converted];
        document.getElementById("orderResult").innerText =
          `您點的是 ${dish.name}，價格為 ${dish.price} 元`;
      } else {
        const bestMatch = findBestMatch(converted);
        if (bestMatch) {
          const { key, similarity } = bestMatch;
          document.getElementById("orderResult").innerText =
            `推薦您點：${menu[key].name} （相似度：${(similarity * 100).toFixed(1)}%），價格為 ${menu[key].price} 元`;
        } else {
          document.getElementById("orderResult").innerText = "未找到相似菜品！";
        }
      }
    }

    // 找出最相似的菜單項目（採用積分算法：相同字母出現次數越多得分越高）
    function findBestMatch(input) {
      let bestKey = null;
      let bestScore = 0;
      for (let key in menu) {
        const score = letterFrequencySimilarity(input, key);
        if (score > bestScore) {
          bestScore = score;
          bestKey = key;
        }
      }
      return bestKey ? { key: bestKey, similarity: bestScore } : null;
    }

    // 積分算法：計算兩個字串中相同字母的最小出現次數總和，並以較長字串長度正規化
    function letterFrequencySimilarity(a, b) {
      const freqA = getLetterFrequency(a);
      const freqB = getLetterFrequency(b);
      let commonCount = 0;
      for (let letter in freqA) {
        if (freqB[letter]) {
          commonCount += Math.min(freqA[letter], freqB[letter]);
        }
      }
      return commonCount / Math.max(a.length, b.length);
    }

    // 計算字母出現頻率
    function getLetterFrequency(str) {
      const freq = {};
      for (let char of str) {
        freq[char] = (freq[char] || 0) + 1;
      }
      return freq;
    }

    // 自動生成英文關鍵字，除非使用者手動修改
    document.getElementById("menuName").addEventListener("input", function () {
      if (!manualEditKey) {
        const name = this.value.trim();
        let key = "";
        for (let i = 0; i < name.length; i++) {
          const ch = name.charAt(i);
          if (charMapping[ch] !== undefined) {
            key += charMapping[ch];
          }
        }
        document.getElementById("menuKey").value = key;
      }
    });

    // 當使用者手動編輯英文關鍵字時，設定標記
    document.getElementById("menuKey").addEventListener("input", function () {
      manualEditKey = true;
    });
  </script>
</body>
</html>