<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>中文點餐系統</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      padding: 0;
    }
    input, button {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      cursor: pointer;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
    li:hover {
      background-color: #f0f0f0;
    }
    @media (max-width: 600px) {
      input, button { font-size: 18px; }
    }
    /* Modal 樣式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1>中文點餐系統</h1>

  <!-- 點餐區 -->
  <section>
    <h2>請輸入中文菜品名稱</h2>
    <input type="text" id="orderInput" placeholder="例如：蔥油餅">
    <button onclick="orderFromChinese()">送出訂單</button>
    <p>訂單結果：<span id="orderResult"></span></p>
  </section>

  <!-- 自動讀取轉譯字庫 -->
  <section>
    <h2>轉譯字庫載入狀態</h2>
    <p id="dbStatus">尚未載入字庫資料...</p>
  </section>

  <!-- 菜單管理區 -->
  <section>
    <h2>菜單管理</h2>
    <button onclick="openMenuModal()">新增菜單</button>
    <button onclick="downloadMenuData()">下載菜單資料</button>
    <button onclick="document.getElementById('uploadMenuFile').click()">上傳菜單資料</button>
    <input type="file" id="uploadMenuFile" accept=".txt" style="display:none;" onchange="uploadMenuData()">
    <div id="menuList"></div>
  </section>

  <!-- 新增/編輯菜單彈出視窗 -->
  <div id="menuModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeMenuModal()">&times;</span>
      <h3 id="modalTitle">新增菜單項目</h3>
      <div class="form-group">
        <label for="menuName">菜品名稱 (中文)：</label>
        <input type="text" id="menuName" placeholder="例如: 蔥油餅">
      </div>
      <div class="form-group">
        <label for="menuKey">點餐關鍵字 (英文，可手動編輯)：</label>
        <input type="text" id="menuKey" placeholder="自動轉譯或手動輸入">
      </div>
      <div class="form-group">
        <label for="menuPrice">價格：</label>
        <input type="number" id="menuPrice" placeholder="例如: 20">
      </div>
      <button id="saveButton" onclick="saveMenuItem()">儲存</button>
      <button id="deleteButton" onclick="deleteMenuItem()" style="display:none; background-color:red; color:white;">刪除</button>
      <button onclick="closeMenuModal()">取消</button>
    </div>
  </div>

  <script>
    // 全域資料
    let groupMapping = {};
    let charMapping = {};
    let menu = {
      "chonyobin": { name: "蔥油餅", price: 20 }
    };
    let currentEditingKey = null;
    let manualEditKey = false; // 判斷是否手動編輯關鍵字

    // 自動從同一伺服器的 database.txt 讀取字庫資料
    function loadTranslationDatabase() {
      fetch("database.txt")
        .then(response => {
          if (!response.ok) throw new Error("無法讀取 database.txt");
          return response.text();
        })
        .then(text => {
          const db = JSON.parse(text);
          if (db.groupMapping && db.charMapping) {
            groupMapping = db.groupMapping;
            charMapping = db.charMapping;
            document.getElementById("dbStatus").innerText = "字庫資料載入成功！";
          } else {
            document.getElementById("dbStatus").innerText = "database.txt 格式不正確！";
          }
        })
        .catch(err => {
          document.getElementById("dbStatus").innerText = "載入字庫資料失敗：" + err.message;
        });
    }
    loadTranslationDatabase();

    // 更新菜單顯示
    function updateMenuDisplay() {
      let menuListDiv = document.getElementById("menuList");
      menuListDiv.innerHTML = "";
      let ul = document.createElement("ul");
      for (let key in menu) {
        if (menu.hasOwnProperty(key)) {
          let li = document.createElement("li");
          li.textContent = key + " : " + menu[key].name + " - " + menu[key].price + "元";
          li.onclick = () => openMenuModal(key); // 點擊以編輯
          ul.appendChild(li);
        }
      }
      menuListDiv.appendChild(ul);
    }
    updateMenuDisplay();

    // 點餐功能
    function orderFromChinese() {
      const input = document.getElementById("orderInput").value.trim();
      if (!input) {
        alert("請輸入中文菜品名稱！");
        return;
      }

      let converted = "";
      for (let i = 0; i < input.length; i++) {
        const ch = input.charAt(i);
        if (charMapping[ch] !== undefined) {
          converted += charMapping[ch];
        }
      }

      if (menu[converted]) {
        const dish = menu[converted];
        document.getElementById("orderResult").innerText =
          `您點的是 ${dish.name}，價格為 ${dish.price} 元`;
      } else {
        let bestMatch = findBestMatch(converted);
        if (bestMatch) {
          const { key, similarity } = bestMatch;
          document.getElementById("orderResult").innerText =
            `找不到完全相符項目，推薦您點：${menu[key].name} （相似度：${(similarity * 100).toFixed(1)}%），價格為 ${menu[key].price} 元`;
        } else {
          document.getElementById("orderResult").innerText = "未找到相似菜品！";
        }
      }
    }

    // 找到最相似的菜品（基於字母出現頻率比對）
    function findBestMatch(input) {
      let bestKey = null;
      let bestSimilarity = 0;

      for (let key in menu) {
        const similarity = letterFrequencySimilarity(input, key);
        if (similarity > bestSimilarity) {
          bestSimilarity = similarity;
          bestKey = key;
        }
      }

      return bestKey ? { key: bestKey, similarity: bestSimilarity } : null;
    }

    // 基於字母頻率的相似度比對
    function letterFrequencySimilarity(a, b) {
      const freqA = getLetterFrequency(a);
      const freqB = getLetterFrequency(b);

      let intersection = 0;
      let total = 0;

      for (let letter in freqA) {
        if (freqB[letter]) {
          intersection += Math.min(freqA[letter], freqB[letter]);
        }
        total += freqA[letter];
      }

      for (let letter in freqB) {
        total += freqB[letter];
      }

      return intersection / total;
    }

    // 統計字母出現頻率
    function getLetterFrequency(str) {
      let freq = {};
      for (let char of str) {
        freq[char] = (freq[char] || 0) + 1;
      }
      return freq;
    }
  </script>
</body>
</html>