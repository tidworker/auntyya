<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>訂單管理 - 葉阿姨點餐系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* 基本樣式 */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      background-color: #f0f0f0;
      color: #333;
    }
    header {
      background: #ddd;
      padding: 15px 0;
      margin-bottom: 20px;
    }
    header h2 {
      margin: 0;
      font-size: 24px;
      color: #333;
    }
    .order-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 10px;
    }
    .order-block {
      background-color: #fff;
      border: 1px solid #aaa;
      margin-bottom: 20px;
      padding: 10px;
      text-align: left;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
    }
    .order-header h3 {
      margin: 0;
      font-size: 20px;
    }
    .order-list {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .order-list th, .order-list td {
      border: 1px solid #aaa;
      padding: 8px;
      font-size: 16px;
      text-align: center;
      /* 防止文字被選取 */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    .order-list th {
      background: #ddd;
      color: #333;
    }
    /* 點選品項名稱時切換為淺紅色 */
    .faded {
      color: #ff6666;
    }
    .total-price {
      font-size: 18px;
      text-align: right;
      margin-top: 5px;
      font-weight: bold;
    }
    /* 外帶/內用資訊顯示在表格下方 */
    .order-type {
      margin-top: 10px;
      font-size: 16px;
      padding: 8px;
      text-align: center;
    }
    .takeout {
      background-color: #ffcccc;
    }
    .dinein {
      background-color: #cce5ff;
    }
    /* 底部動作按鈕區：左右排列 */
    .actions {
      display: flex;
      justify-content: space-between;
      margin: 20px auto;
      max-width: 600px;
    }
    .menu-button {
      font-size: 20px;
      padding: 14px 22px;
      cursor: pointer;
      border: none;
      background-color: #555;
      color: #fff;
      transition: background-color 0.2s;
      width: 48%;
    }
    .menu-button:hover {
      background-color: #333;
    }
    /* 備註設定 Modal */
    .note-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow-y: auto;
    }
    .note-modal-content {
      background-color: #f9f9f9;
      margin: 15% auto;
      padding: 20px;
      width: 300px;
      text-align: center;
      position: relative;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .close-note {
      position: absolute;
      right: 10px;
      top: 5px;
      font-size: 24px;
      color: #f00;
      cursor: pointer;
    }
    .note-modal label {
      font-size: 16px;
      margin-right: 5px;
    }
    .note-modal input[type="time"],
    .note-modal select {
      font-size: 16px;
      padding: 4px;
      margin-bottom: 10px;
    }
    .note-modal button {
      font-size: 16px;
      padding: 6px 12px;
      border: none;
      background-color: #555;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-top: 10px;
    }
    .note-modal button:hover {
      background-color: #333;
    }
  </style>
</head>
<body>
  <header>
    <h2>訂單管理</h2>
  </header>

  <div class="order-container" id="orderContainer">
    <!-- 訂單內容將在此處生成 -->
  </div>

  <div class="actions">
    <button class="menu-button" onclick="goBackMenu()">返回 Menu</button>
    <button class="menu-button" onclick="resetOrderNumber()">重置編號</button>
  </div>

  <!-- 備註設定 Modal -->
  <div id="noteModal" class="note-modal">
    <div class="note-modal-content">
      <span class="close-note" onclick="closeNoteModal()">&times;</span>
      <h3>設定備註</h3>
      <div>
        <input type="radio" id="takeout" name="orderType" value="外帶" checked onclick="toggleOrderType()">
        <label for="takeout">外帶</label>
        <input type="radio" id="dinein" name="orderType" value="內用" onclick="toggleOrderType()">
        <label for="dinein">內用</label>
      </div>
      <div id="takeoutOption">
        <label>取餐時間：</label>
        <input type="time" id="pickupTime">
      </div>
      <div id="dineinOption" style="display:none;">
        <label>桌號：</label>
        <select id="tableNumber">
          <option value="R1">R1</option>
          <option value="R2">R2</option>
          <option value="M1">M1</option>
          <option value="M2">M2</option>
          <option value="M3">M3</option>
          <option value="L1">L1</option>
        </select>
      </div>
      <button onclick="saveNoteInfo()">儲存</button>
    </div>
  </div>

  <script>
    let currentOrderIndex = null;
    
    // 定義自訂排序陣列
    const orderPriority = [
      "蔥油餅",
      "蔥油餅加蛋",
      "大腸麵線",
      "肉羹麵線",
      "綜合麵線",
      "清麵線",
      "純麵線",
      "大炒麵",
      "小炒麵",
      "荷包蛋",
      "貢丸湯",
      "肉羹湯",
      "綜合湯",
      "紅茶",
      "奶茶",
      "豆漿",
      "米漿"
    ];

    function goBackMenu(){
      window.location.href = "index.html";
    }
    function resetOrderNumber(){
      if(confirm("是否確定重置訂單編號？")){
        localStorage.setItem("orderNumberCounter", 1);
        alert("訂單編號已重置。");
      }
    }
    
    function toggleOrderType(){
      let isTakeout = document.getElementById("takeout").checked;
      document.getElementById("takeoutOption").style.display = isTakeout ? "block" : "none";
      document.getElementById("dineinOption").style.display = isTakeout ? "none" : "block";
    }
    
    function openNoteModal(index){
      currentOrderIndex = index;
      let ordersStr = localStorage.getItem("allOrders");
      if(ordersStr){
        let allOrders = JSON.parse(ordersStr);
        let order = allOrders[index];
        if(order.orderType === "內用"){
          document.getElementById("dinein").checked = true;
          document.getElementById("takeout").checked = false;
          document.getElementById("dineinOption").style.display = "block";
          document.getElementById("takeoutOption").style.display = "none";
          document.getElementById("tableNumber").value = order.tableNumber || "R1";
        } else if(order.orderType === "外帶"){
          document.getElementById("takeout").checked = true;
          document.getElementById("dinein").checked = false;
          document.getElementById("takeoutOption").style.display = "block";
          document.getElementById("dineinOption").style.display = "none";
          document.getElementById("pickupTime").value = order.pickupTime || "";
        } else {
          document.getElementById("takeout").checked = true;
          document.getElementById("dinein").checked = false;
          document.getElementById("takeoutOption").style.display = "block";
          document.getElementById("dineinOption").style.display = "none";
        }
      }
      document.getElementById("noteModal").style.display = "block";
    }
    
    function closeNoteModal(){
      document.getElementById("noteModal").style.display = "none";
    }
    
    function saveNoteInfo(){
      let allOrders = JSON.parse(localStorage.getItem("allOrders"));
      let order = allOrders[currentOrderIndex];
      if(document.getElementById("takeout").checked){
        order.orderType = "外帶";
        order.pickupTime = document.getElementById("pickupTime").value;
      } else {
        order.orderType = "內用";
        order.tableNumber = document.getElementById("tableNumber").value;
      }
      allOrders[currentOrderIndex] = order;
      localStorage.setItem("allOrders", JSON.stringify(allOrders));
      closeNoteModal();
      loadOrders();
    }
    
    function loadOrders(){
      let ordersStr = localStorage.getItem("allOrders");
      let orderContainer = document.getElementById("orderContainer");
      orderContainer.innerHTML = "";
      if(!ordersStr || JSON.parse(ordersStr).length === 0){
        orderContainer.innerHTML = "<p>目前沒有訂單</p>";
        return;
      }
      let allOrders = JSON.parse(ordersStr);
      allOrders.forEach((order, index) => {
        let orderBlock = document.createElement("div");
        orderBlock.className = "order-block";
        
        let headerDiv = document.createElement("div");
        headerDiv.className = "order-header";
        headerDiv.innerHTML = `<h3>訂單編號：${order.orderId}</h3>
          <button onclick="openNoteModal(${index})">備註</button>
          <button onclick="deleteOrder(${index})">刪除訂單</button>`;
        orderBlock.appendChild(headerDiv);
        
        let table = document.createElement("table");
        table.className = "order-list";
        table.innerHTML = `<thead>
          <tr>
            <th>品項</th>
            <th>數量</th>
            <th>備註</th>
            <th>小計</th>
          </tr>
        </thead><tbody></tbody>`;
        let tbody = table.querySelector("tbody");
        let orderTotal = 0;
        
        // 將 order.items 的品項名稱依照 orderPriority 排序
        let sortedItemNames = Object.keys(order.items).sort((a, b) => {
          let indexA = orderPriority.indexOf(a);
          let indexB = orderPriority.indexOf(b);
          if(indexA === -1) indexA = orderPriority.length;
          if(indexB === -1) indexB = orderPriority.length;
          return indexA - indexB;
        });
        
        sortedItemNames.forEach(itemName => {
          let item = order.items[itemName];
          let subTotal = item.price * item.quantity;
          orderTotal += subTotal;
          let row = document.createElement("tr");
          row.innerHTML = `<td onclick="this.classList.toggle('faded')">${itemName}</td>
                           <td>${item.quantity}</td>
                           <td>${item.remark || "-"}</td>
                           <td>$${subTotal}</td>`;
          tbody.appendChild(row);
        });
        
        orderBlock.appendChild(table);
        
        let totalDiv = document.createElement("div");
        totalDiv.className = "total-price";
        totalDiv.innerText = "總金額：$" + orderTotal;
        orderBlock.appendChild(totalDiv);
        
        if(order.orderType){
          let noteDiv = document.createElement("div");
          noteDiv.className = "order-type " + (order.orderType === "外帶" ? "takeout" : "dinein");
          if(order.orderType === "外帶"){
            noteDiv.innerText = `外帶，取餐時間：${order.pickupTime || "未設定"}`;
          } else {
            noteDiv.innerText = `內用，桌號：${order.tableNumber || "未設定"}`;
          }
          orderBlock.appendChild(noteDiv);
        }
        
        orderContainer.appendChild(orderBlock);
      });
    }
    
    function deleteOrder(index){
      if(confirm("是否確定刪除訂單？")){
        let allOrders = JSON.parse(localStorage.getItem("allOrders"));
        allOrders.splice(index, 1);
        localStorage.setItem("allOrders", JSON.stringify(allOrders));
        loadOrders();
      }
    }
    
    window.onload = loadOrders;
  </script>
</body>
</html>